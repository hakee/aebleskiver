//    Aebleskiver
//    (c) 2011 Beau Sorensen
//    Aebleskiver may be freely distributed under the MIT license.
//    For all details and documentation:
//    https://github.com/sorensen/aebleskiver

// Mongoose ORM Schemas
// --------------------

// Exports for CommonJS
var Schemas;
if (typeof exports !== 'undefined') {
    bcrypt   = require('bcrypt');
    Mongoose = require('mongoose');
    Schema   = Mongoose.Schema;
    ObjectId = Schema.ObjectId;
    Schemas  = module.exports = {};
}

//###extractKeywords
// Keyword extractor for mongodb searchability
function extractKeywords(text) {
  if (!text) return [];
  return text
    .toLowerCase()
    .split(/\s+/)
    .filter(function(v) { return v.length > 2; })
    .filter(function(v, i, a) { return a.lastIndexOf(v) === i; });
}

//###validatePresenceOf
// Simple required field validator
function validatePresenceOf(value) {
    return value && value.length;
}

//###encryptPassword
// Asynchronous bcrypt password protection
function encryptPassword(password) {
    return bcrypt.encrypt_sync(password, bcrypt.gen_salt_sync(10));
}

//##Schemas
// Basic schema definitions initialized here, schema 
// methods and custom getters/setters that interact with 
// other schemas / models will need them to be defined first
Schemas = {

    //###Message
    // Basic message generated by a user
    Message : new Schema({
        room     : { type : String, index : true },
        text     : String,
        username : String,
        to       : ObjectId,
        user_id  : String,
        avatar   : String,
        created  : { type : Date, default : Date.now },
        modified : { type : Date, default : Date.now }
    }),

    //###Room
    // Basic chat room for storing messages, holds a list of 
    // indexes for message lookup, as well as white and blacklisted 
    // users. Fields for URL slugs and ranking mechanics as well.
    Room : new Schema({
        name        : { type : String, index : { unique : true } },
        slug        : { type : String, index : { unique : true } },
        user_id     : ObjectId,
        tags        : Array,
        keywords    : [String],
        description : String,
        rank        : Number,
        restricted  : String,
        allowed     : Array,
        banned      : Array,
        upvotes     : { type : Number, default : 0 },
        downvotes   : { type : Number, default : 0 },
        created     : { type : Date, default : Date.now },
        modified    : { type : Date, default : Date.now }
    }),

    //###Conversation
    // More fine tuned version of a `Room`, fields removed 
    // that are not necessary in a user to user chat.
    Conversation : new Schema({
        user_id     : ObjectId,
        users       : Array,
        created     : { type : Date, default : Date.now },
        modified    : { type : Date, default : Date.now }
    }),

    //###User
    // Main user object of the application, stores details about 
    // `Room` favorites as well as general profile information.
    User : new Schema({
        username         : { type : String, index : { unique : true } },
        email            : { type : String, index : { unique : true } },
        status           : { type : String, index : true },
        visits           : Number,
        displayName      : String,
        bio              : String,
        avatar           : String,
        crypted_password : String,
        profile_image    : String,
        images           : Array,
        friends          : Array,
        blocked          : Array,
        restricted       : String,
        favorites        : Array,
        created          : { type : Date, default : Date.now },
        modified         : { type : Date, default : Date.now }
    }),
    
    //###Application
    // Application schema, not currently used, but can be set 
    // in the future for DB configurables / simple analytics, 
    // there should probably never be more than one
    Application : new Schema({
        server  : { type : String, index : { unique : true } },
        visits  : Number
    }),
    
    //###Session
    // Session defined to match connect-mongodb package sessions, 
    // to allow tighter integration between Express / Mongoose, 
    // which will ultimately trickle down to Backbone ease-of-use
    Session : new Schema({
        _id     : String,
        session : { type : String, get : function() {
            return JSON.parse(this.session);
        }},
        expires : Number
    }),
    
    //###Token
    // Login tokens for authentication persistance
    Token : new Schema({
        email  : { type: String, index: true },
        series : { type: String, index: true },
        token  : { type: String, index: true }
    })
};

// User virtuals and methods
// -------------------------

//###virtual-password
// Set the user provided password into a non persisted
// attribute, then encrypt to check against later
Schemas.User
    .virtual('password')
    .set(function(password) {
        this._password = password;
        this.set('crypted_password', encryptPassword(password));
    })
    .get(function() {
        return this._password; 
    });

//###authenticate
// Check the stored encrypted password against the user 
// provided one, general A1 security check
Schemas.User
    .method('authenticate', function(password) {
        //return bcrypt.compare_sync(password, this.crypted_password);
        bcrypt.compare(password, this.crypted_password, function(err, result) {
            return result;
        });
    });

//###pre-save
// Ensure that the model has a valid password set on it before
// saving any data, as well as set the modified timestamp.
Schemas.User
    .pre('save', function(next) {
        if (!validatePresenceOf(this.password)) {
            next(new Error('Invalid password'));
        } else {
            this.set('modified', new Date());
            next();
        }
    });

// Room methods
// ------------

//###pre-save
// Extract keywords out of the name and description
// of the room for mongodb searching, as well as set
// the last modified timestamp
Schemas.Room
    .pre('save', function(next) {
        this.set('modified', new Date());
        var keywords = extractKeywords(this.name);
        var descwords = extractKeywords(this.description);
        
        var concat = keywords.concat(descwords);
        this.keywords = _.unique(concat);
        next();
    });

//###set-name
// Create a URL friendly version of the room name
// everytime the attribute is set
Schemas.Room
    .path('name')
    .set(function(v){
        this.slug = v
            .toLowerCase()
            .replace(/[^a-z0-9]/g, '')
            .replace(/-+/g, '');
        return v;
    });
    
    
// Token virtuals and methods
// --------------------------

//###random_token
// Create a randomized number to be used for creating 
// integer based token values on each save
Schemas.Token
    .method('random_token', function() {
        return Math.round((new Date().valueOf() * Math.random())) + '';
    });

//###pre-save
// Automatically create a new random value for the 
// current token, while advancing it along the series.
Schemas.Token
    .pre('save', function(next) {
        this.token = this.randomToken();
        if (this.isNew)
        this.series = this.randomToken();
        next();
    });

//###virtual-id
// Serve up a hexed version of the mongodb ObjectID
Schemas.Token
    .virtual('id')
    .get(function() {
        return this._id.toHexString();
    });

//###virtual-cookie_value
// Serve up a serialized JSON object for cookie 
// based saving and lookup
Schemas.Token
    .virtual('cookie_value')
    .get(function() {
        return JSON.stringify({ 
            email  : this.email, 
            token  : this.token, 
            series : this.series 
        });
    });

// Register the models with Mongoose
Mongoose.model('user',         Schemas.User);
Mongoose.model('room',         Schemas.Room);
Mongoose.model('token',        Schemas.Token);
Mongoose.model('message',      Schemas.Message);
Mongoose.model('session',      Schemas.Session);
Mongoose.model('application',  Schemas.Application);
Mongoose.model('conversation', Schemas.Conversation);

